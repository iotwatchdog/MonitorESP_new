<style>
    .row .icon-box>.icon,
    .row .icon-box {
        height: 70px !important;
    }

    .row .icon-box>.icon {
        width: 70px !important;
        height: 68px !important;
    }

    .row .icon-box>.content {
        line-height: 1.6;
    }
</style>

<div class="container mt-3" id="main-board">
</div>

<script>
    var panelCustomButtons = [
        {
            html: "<span class='mif-chart-dots'></span>",
            cls: "sys-button",
            onclick: "alert('You press rocket button')"
        },
        {
            html: "<span class='mif-table'></span>",
            cls: "sys-button",
            onclick: "alert('You press rocket button')"
        }
    ];
    (function () {
        $(document).ready(function () {


            $.ajax({
                url: urlserver + '/get-loadmonitor',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    response.forEach(e => {
                        console.log('painel', e)
                        $('#main-board').append(`<div class="mt-1" data-id="panel-${e.idpainel}" data-role="panel" data-title-caption="${e.idpainel} - ${e.painel}" data-collapsible="true"
                                                    data-cls-title="bg-cyan fg-white" data-cls-panel="shadow-1" data-title-icon="<span class='mif-meter'></span>"></div>`);
                        //data-custom-buttons="panelCustomButtons" 
                        e.sensors.forEach(s => {
                            console.log(s)
                            $(`[data-id="panel-${e.idpainel}`).append(
                                `<div class="row">
                                    <div class="cell-lg-12 cell-sm-12">
                                        <div class="icon-box border bd-default">
                                            <div id="chart_div"></div>
                                            <div class="icon " id="span-bg"><span id="span-ico" class="mif-thermometer2"></span></div>
                                            <div class="content p-1" style="font-size: 12px;">
                                                <div class="text-upper text-bold text-lead" id="div-sensor-${s.id}">${s.sensor}</div>
                                                <div class="text-upper">temperatura: <span class="text-bold" id="span-value-${s.id}"> 2 °C</span></div>
                                                <div class="text-upper">atualizado em: <span class="text-bold" id="span-timestamp-${s.id}"> 08/25/2023 03:07:44</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="cell-lg-6 cell-sm-12">
                                        <div data-id="panel-chart-${s.id}" data-role="panel" data-title-caption="GRÁFICO" data-collapsible="true"
                                            data-collapsed="true" data-title-icon="<span class='mif-chart-dots'></span>">
                                            <div d-flex flex-justify-center" style="max-height: 40vh;">
                                                <canvas id="chart-${s.id}"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="cell-lg-6 cell-sm-12">
                                         <div data-id="panel-tablemonitor-${s.id}" data-role="panel" data-title-caption="LOG" data-collapsible="true"
                                            data-collapsed="true" data-title-icon="<span class='mif-table'></span>">
                                                     <table id="table-monitorhistory-${s.id}" class="table compact striped table-border" data-role="table" data-cls-component="mt-2" data-rows="50" data-pagination="true" data-show-all-pages="false">
                                                         <thead>
                                                             <tr>
                                                                 <th data-sortable=true data-format="number">Valor</th>
                                                                 <th data-sortable=true data-format="date">Data/Hora</th>
                                                             </tr>
                                                         </thead>
                                                    </table>
                                        </div>
                                    </div>
                                </div>`
                            );
                        });
                    });


                    const data = response.reduce((result, item) => {
                        result[item.id] = item.id + ' - ' + item.name;
                        return result;
                    }, {});
                },
                error: function (error) {
                    console.error('Erro ao carregar branches:', error);
                }
            });
        });

        //let tempoAcumulado = 0;

        //const ws = new WebSocket(server.teste.ws);
        const ws = new WebSocket('wss://iotlsmonitor.onrender.com/');

        ws.addEventListener('open', () => {
            console.log('Conectado ao servidor via WebSocket');
        });
        var alert = 0;
        var firstload = 0;
        ws.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            console.log(data)
            const novaMensagem = data
            adicionarNovosDados(novaMensagem);
            $(`#span-value-${data.deviceId}`).text(data.value + " °C");
            $(`#span-timestamp-${data.deviceId}`).text(data.timestamp);
            if (firstload === 0) {
                firstload = 1;
                $(`#table-monitorhistory-${data.deviceId}`).data('table').loadData(`${urlserver}/get-table-monitorhistory?sensorpanelid=${data.deviceId}`, true);

            } else {
                var rows = [data.value, data.timestamp]
                var tbl = Metro.getPlugin(`#table-monitorhistory-${data.deviceId}`, 'table');
                tbl.addItem(rows, true);
            }
            //$(`#table-monitorhistory-${data.deviceId}`).data('table')
            // if (data.value > 60) {
            //     $('#span-ico').addClass('ani-shuttle')
            //     $('#span-bg').addClass('ribbed-red').addClass('fg-white')
            //     if (alert === 0) {
            //         //Metro.infobox.create("<p>Lorem Ipsum is simply dummy text...</p>", "alert");
            //         openDemoDialogActions('Alerta de Temperatura', 'Este alerta é gerado quando a temperatura ultrapassa 60°C.');
            //         alert = 1;
            //     }
            // } else if (data.value < 0) {
            //     $('#span-ico').addClass('ani-shuttle')
            //     $('#span-bg').removeClass('ribbed-red').addClass('ribbed-cyan').addClass('fg-white')
            //     if (alert === 0) {
            //         //openDemoDialogActions('Alerta de Temperatura', 'Este alerta é gerado quando a temperatura ultrapassa 60°C.');
            //         alert = 1;
            //     }
            // } else {
            //     $('#span-ico').removeClass('ani-shuttle')
            //     $('#span-bg').removeClass('fg-white')
            //     $('#span-bg').removeClass('ribbed-red').removeClass('ribbed-cyan')
            // }

        });

        ws.addEventListener('close', () => {
            console.log('Conexão fechada');
        });
        var customButtons = [
            {
                html: "<span class='mif-chart-dots'></span>",
                cls: "sys-button",
                onclick: "alert('You press rocket button')"
            },
            {
                html: "<span class='mif-table'></span>",
                cls: "sys-button",
                onclick: "alert('You press rocket button')"
            }
        ];
        // Defina um limite máximo para o número de pontos de dados a serem mantidos (25 neste caso).
        const maxDataPoints = 25;

        // Variáveis para armazenar os dados do gráfico.
        let chartLabels = [];
        let chartData = [];

        // const ctx = document.getElementById('myChart_temp');

        // // Crie o gráfico inicial com os arrays vazios.
        // const chart = new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //         labels: chartLabels,
        //         datasets: [{
        //             label: 'Temperatura',
        //             data: chartData,
        //             borderWidth: 2
        //         }],
        //     },
        //     options: {
        //         // ... (suas opções de gráfico existentes)
        //     }
        // });

        // Função para adicionar novos dados ao gráfico.
        function adicionarNovosDados(mensagem) {
            // Adicione a nova label de timestamp aos dados do gráfico.
            const hora = mensagem.timestamp.split(' ')[1];
            chartLabels.push(hora);

            // Adicione o novo valor aos dados do gráfico.
            chartData.push(parseFloat(mensagem.value));

            // Verifique se o número de pontos de dados excede o limite máximo.
            if (chartLabels.length > maxDataPoints) {
                // Remova o elemento mais antigo.
                chartLabels.shift();
                chartData.shift();
            }

            // Atualize o gráfico.
            //chart.update();
        }

        // Exemplo de uso: Chame a função adicionarNovosDados sempre que receber uma nova mensagem.
        const novaMensagem = { deviceId: 16, value: '67.63', timestamp: '01/09/2023 15:40:50' };
        //adicionarNovosDados(novaMensagem);


        // const ctx = document.getElementById('myChart_temp');
        // new Chart(ctx, {
        //     type: 'line',
        //     data: {
        //         labels: [
        //             '01:51:00', '01:51:10', '01:51:20', '01:51:30', '01:51:40', '01:51:50',
        //             '01:52:00', '01:52:10', '01:52:20', '01:52:30', '01:52:40', '01:52:50',
        //             '01:53:00', '01:53:10', '01:53:20', '01:53:30', '01:53:40', '01:53:50',
        //             '01:54:00', '01:54:10', '01:54:20', '01:54:30', '01:54:40', '01:54:50'

        //         ],
        //         datasets: [{
        //             label: 'Temperatura',
        //             data: [
        //                 4, 5, 5, 5, 5, 5,
        //                 5, 0, 5, 7, 5, 5,
        //                 5, 7, 5, 5, 5, 7,
        //                 5, 5, 0, 3, 1, 3
        //             ],
        //             borderWidth: 2
        //         }],
        //     },
        //     options: {
        //         scales: {
        //             y: {
        //                 stacked: true,
        //                 grid: {
        //                     display: true,
        //                 }
        //             },
        //             x: {
        //                 grid: {
        //                     display: true
        //                 }
        //             }
        //         },
        //         layout: {
        //             padding: {
        //                 left: 0,
        //                 right: 0,
        //                 top: 0,
        //                 bottom: 0
        //             }
        //         },
        //         barPercentage: 0.8,
        //         categoryPercentage: 0.9
        //     }
        // });
    })();
</script>