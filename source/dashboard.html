<style>
    .row .icon-box>.icon,
    .row .icon-box {
        height: 70px !important;
    }

    .row .icon-box>.icon {
        width: 70px !important;
        height: 68px !important;
    }

    .row .icon-box>.content {
        line-height: 1.6;
    }

    .compact td {
        padding: 3px !important;
    }
</style>

<div class="container mt-3" id="main-board">

    <!-- <div class="d-flex flex-justify-center" style="max-height: 40vh;">
        <canvas id="chart"></canvas>
    </div> -->
</div>

<script>
    var panelCustomButtons = [
        {
            html: "<span class='mif-chart-dots'></span>",
            cls: "sys-button",
            onclick: "alert('You press rocket button')"
        },
        {
            html: "<span class='mif-table'></span>",
            cls: "sys-button",
            onclick: "alert('You press rocket button')"
        }
    ];
    (function () {
        const graficos = {};
        function criarGrafico(id) {
            const canvas = document.createElement('canvas');
            canvas.id = `chart-${id}`;
            const pai = document.getElementById(`div-chart-${id}`);
            pai.appendChild(canvas)
            canvas.style.width = '100%';
            canvas.style.maxHeight = '40vh';
            //document.body.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const novoGrafico = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Temperatura',
                        data: [],
                        borderWidth: 2
                    }],
                },
                options: {
                    // ... (suas opções de gráfico existentes)
                }
            });
            graficos[id] = novoGrafico;
        }

        function adicionarDadosAoGrafico(id, mensagem) {
            const grafico = graficos[id];

            if (grafico) {
                const hora = mensagem.timestamp.split(' ')[1];
                grafico.data.labels.push(hora);
                grafico.data.datasets[0].data.push(parseFloat(mensagem.value));

                // Verifique se o número de pontos de dados excede o limite máximo.
                if (grafico.data.labels.length > 25) {
                    grafico.data.labels.shift();
                    grafico.data.datasets[0].data.shift();
                }

                // Atualize o gráfico.
                grafico.update();
            } else {
                // Se o gráfico com o ID especificado não existir, crie-o.
                criarGrafico(id);
                adicionarDadosAoGrafico(id, mensagem);
            }
        }
        $(document).ready(function () {
            $.ajax({
                url: urlserver + '/get-loadmonitor',
                type: 'GET',
                dataType: 'json',
                success: function (response) {
                    response.forEach(e => {
                        $('#main-board').append(`<div class="mt-1" data-id="panel-${e.idpainel}" data-role="panel" data-title-caption="${e.empresa} - ${e.painel}" data-collapsible="true"
                                                    data-cls-title="bg-cyan fg-white" data-cls-panel="shadow-1" data-title-icon="<span class='mif-meter'></span>"></div>`);
                        //data-custom-buttons="panelCustomButtons" 
                        e.sensors.forEach(s => {
                            $(`[data-id="panel-${e.idpainel}`).append(
                                `<div class="row">
                                    <div class="cell-lg-12 cell-sm-12">
                                        <div class="icon-box border bd-default">
                                            <div class="icon " id="span-bg-${s.id}"><span id="span-ico-${s.id}" class="mif-thermometer2"></span></div>
                                            <div class="content p-1" style="font-size: 12px;">
                                                <div class="text-upper text-bold text-lead" id="div-sensor-${s.id}">${s.sensor}</div>
                                                <div class="text-upper">temperatura: <span class="text-bold fg-red" id="span-value-${s.id}"> Offline</span></div>
                                                <div class="text-upper">atualizado em: <span class="text-bold fg-red" id="span-timestamp-${s.id}"> Offline</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="cell-lg-12 cell-sm-12">
                                        <div data-id="panel-chart-${s.id}" data-role="panel" data-title-caption="GRÁFICO & LOG" data-collapsible="true"
                                            data-collapsed="true" data-title-icon="<span class='mif-chart-dots'></span>">
                                            <div class="row">
                                                <div class="cell-lg-8 cell-sm-12">
                                                    <div id="div-chart-${s.id}" class="d-flex flex-justify-center">
                                                    </div>
                                                </div>
                                                <div class="cell-lg-4 cell-sm-12">
                                                    <table id="table-monitorhistory-${s.id}" class="table compact striped table-border" data-role="table" data-rows="20" 
                                                    data-pagination="true" data-show-all-pages="false" data-show-search="false" data-show-rows-steps="false">
                                                         <thead>
                                                             <tr>
                                                                 <th data-sortable=true data-format="number">Valor</th>
                                                                 <th data-sortable=true data-format="datetime">Data/Hora</th>
                                                             </tr>
                                                         </thead>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>`
                            );
                            criarGrafico(s.id);
                        });
                    });
                    //<canvas id="chart-${s.id}"></canvas>
                    const data = response.reduce((result, item) => {
                        result[item.id] = item.id + ' - ' + item.name;
                        return result;
                    }, {});
                },
                error: function (error) {
                    console.error('Erro ao carregar branches:', error);
                }
            });
        });

        //let tempoAcumulado = 0;

        //const ws = new WebSocket(server.teste.ws);
        const ws = new WebSocket('wss://iotlsmonitor.onrender.com/');

        ws.addEventListener('open', () => {
            console.log('Conectado ao servidor via WebSocket');
        });
        var alert = 0;
        var firstload = 0;
        ws.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            console.log(data)
            const novaMensagem = data
            adicionarDadosAoGrafico(data.deviceId, novaMensagem)
            $(`#span-value-${data.deviceId}`).text(data.value + " °C").removeClass('fg-red');
            $(`#span-timestamp-${data.deviceId}`).text(data.timestamp).removeClass('fg-red');;
            if (firstload === 0) {
                firstload = 1;
                $(`#table-monitorhistory-${data.deviceId}`).data('table').loadData(`${urlserver}/get-table-monitorhistory?sensorpanelid=${data.deviceId}`, true);

            } else {
                var rows = [data.value, data.timestamp]
                var tbl = Metro.getPlugin(`#table-monitorhistory-${data.deviceId}`, 'table');
                tbl.addItem(rows, true);
            }
            if (data.value > 60) {
                $(`#span-ico-${data.deviceId}`).addClass('ani-shuttle');
                $(`#span-bg-${data.deviceId}`).addClass('ribbed-red').addClass('fg-white');
                if (alert === 0) {
                    openDemoDialogActions('Alerta de Temperatura', 'Este alerta é gerado quando a temperatura ultrapassa 60°C.');
                    alert = 1;
                }
            } else if (data.value < 0) {
                $(`#span-ico-${data.deviceId}`).addClass('ani-shuttle')
                $(`#span-bg-${data.deviceId}`).removeClass('ribbed-red').addClass('ribbed-cyan').addClass('fg-white')
                if (alert === 0) {
                    alert = 1;
                }
            } else {
                $(`#span-ico-${data.deviceId}`).removeClass('ani-shuttle')
                $(`#span-bg-${data.deviceId}`).removeClass('fg-white')
                $(`#span-bg-${data.deviceId}`).removeClass('ribbed-red').removeClass('ribbed-cyan')
            }

        });

        ws.addEventListener('close', () => {
            console.log('Conexão fechada');
        });
    })();
</script>